<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BELL TARGET SHOOTING</title>

  <!-- ─── Google Font ────────────────────────────────────────────────────────── -->
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
    rel="stylesheet"
  />

  <style>
    /* ─── GLOBAL RESET + BASIC SETUP ───────────────────────────────────────────── */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Poppins", sans-serif;
    }
    html, body {
      height: 100%;
    }
    body {
      background: linear-gradient(135deg, #1f2024 0%, #3a416f 100%);
      color: #fafafa;
      text-align: center;
      padding: 20px;
      overflow-x: hidden;
    }

    /* ─── MAIN TITLE & SUBTITLE ────────────────────────────────────────────────── */
    #mainTitle {
      font-weight: 600;
      font-size: 2.8rem;
      letter-spacing: 2px;
      color: #00ffd5;
      text-shadow: 0 2px 8px rgba(0, 255, 213, 0.6);
      margin-bottom: 0.2rem;
    }
    #subtitle {
      font-weight: 400;
      font-size: 1rem;
      color: #d1d1d1;
      margin-bottom: 1.2rem;
      font-style: italic;
    }

    /* ─── STATUS LINE ───────────────────────────────────────────────────────────── */
    #status {
      font-size: 0.95rem;
      margin-bottom: 1em;
      color: #d1d1d1;
    }

    /* ─── SCOREBOARD & PLAYER CARDS ────────────────────────────────────────────── */
    #scoreboard {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .playerBox {
      position: relative;
      width: 160px;
      padding: 1rem 0.8rem;
      background: rgba(255, 255, 255, 0.08);
      border: 2px solid transparent;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      cursor: pointer;
      transition: transform 0.15s ease, border-color 0.15s ease, background 0.15s ease;
    }
    .playerBox:hover {
      transform: translateY(-4px);
      background: rgba(255, 255, 255, 0.12);
    }
    .playerBox.selected {
      border-color: #00ffd5;
      background: rgba(0, 255, 213, 0.08);
      box-shadow: 0 6px 16px rgba(0, 255, 213, 0.4);
    }

    .playerBox input[type="text"] {
      width: 100%;
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      background: transparent;
      border: none;
      text-align: center;
      margin-bottom: 0.4rem;
      outline: none;
    }
    .playerBox input[type="text"]::placeholder {
      color: #ccc;
    }
    .playerBox .score {
      font-size: 2.2rem;
      font-weight: 600;
      color: #00ffd5;
      margin-top: 0.2rem;
      text-shadow: 0 1px 4px rgba(0, 0, 0, 0.5);
    }

    .deleteBtn {
      position: absolute;
      top: 6px;
      right: 8px;
      background: none;
      border: none;
      color: #ff6b6b;
      font-size: 1.1rem;
      cursor: pointer;
      transition: color 0.15s ease;
      outline: none;
    }
    .deleteBtn:hover {
      color: #ff3b3b;
    }

    /* ─── BUTTONS ───────────────────────────────────────────────────────────────── */
    button {
      font-family: "Poppins", sans-serif;
      font-size: 1.05rem;
      font-weight: 600;
      color: #1f2024;
      background: linear-gradient(90deg, #00ffd5 0%, #1affd0 100%);
      border: none;
      border-radius: 8px;
      padding: 0.6rem 1.4rem;
      margin: 0.5rem;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      outline: none;
    }
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
    }
    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* ─── LED CIRCLE ────────────────────────────────────────────────────────────── */
    #led {
      width: 36px;
      height: 36px;
      background-color: #444;
      border-radius: 50%;
      margin: 1rem auto 0;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
      transition: background-color 0.1s ease, box-shadow 0.1s ease;
    }
    /* glowing effect when active */
    #led.active {
      background-color: #00ff8c;
      box-shadow: 0 0 12px rgba(0, 255, 140, 0.8);
    }

    /* ─── NEOPIXEL STRIP SIMULATOR ──────────────────────────────────────────────── */
    #ledStrip {
      margin: 1.5rem auto 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 4px;
      width: fit-content;
    }
    .ledPixel {
      width: 22px;
      height: 22px;
      background-color: #000;
      border-radius: 4px;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
      transition: background-color 0.1s ease, box-shadow 0.1s ease;
    }
    .ledPixel.on {
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.6);
    }

    /* ─── INFO PANEL (DEBUG) ───────────────────────────────────────────────────── */
    #infoPanel {
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
      font-size: 0.9rem;
      color: #ccc;
    }
    #infoPanel div {
      margin-bottom: 0.5rem;
    }
    #infoPanel label {
      display: inline-block;
      width: 130px;
      font-weight: 600;
      color: #fafafa;
    }
    #infoPanel span {
      color: #00ffd5;
    }
  </style>
</head>

<body>
  <!-- ─── FUN TITLE & BYLINE ───────────────────────────────────────────────────── -->
  <h1 id="mainTitle">BELL TARGET SHOOTING</h1>
  <div id="subtitle">by Alex Chavez</div>

  <div id="status">WebSocket closed.</div>

  <!-- ─── SCOREBOARD / PLAYER CARDS ────────────────────────────────────────────── -->
  <div id="scoreboard"></div>

  <!-- ─── “Add Player” BUTTON ───────────────────────────────────────────────────── -->
  <div>
    <button id="btnAddPlayer">Add Player</button>
  </div>

  <!-- ─── “Send Hit” BUTTON ────────────────────────────────────────────────────── -->
  <div>
    <button id="btnHit" disabled>Send Hit</button>
  </div>

  <!-- ─── ON‐SCREEN LED CIRCLE ───────────────────────────────────────────────────── -->
  <div>
    <div id="led"></div>
  </div>

  <!-- ─── NEOPIXEL STRIP SIMULATOR (16 PIXELS) ────────────────────────────────── -->
  <div id="ledStrip"></div>

  <!-- ─── RAW INFO PANEL (FOR DEBUG) ───────────────────────────────────────────── -->
  <div id="infoPanel">
    <div>
      <label>Connection:</label>
      <span id="txtConn">Closed</span>
    </div>
    <div>
      <label>Last WS Message:</label>
      <span id="txtLastMsg">—</span>
    </div>
  </div>

  <script>
    // ─── CHANGE TO YOUR ESP32 IP ────────────────────────────────────────────────
    const ESP32_IP = "192.168.1.18"; // ← replace with your ESP32’s IP
    const WS_URL = "ws://" + ESP32_IP + ":81";

    // ─── HELPERS: sleep() and HSV→HEX ───────────────────────────────────────────
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    function hsvToRgb(h, s, v) {
      const c = v * s;
      const hh = h / 60;
      const x = c * (1 - Math.abs((hh % 2) - 1));
      let r1 = 0, g1 = 0, b1 = 0;
      if (0 <= hh && hh < 1)        { r1 = c; g1 = x; b1 = 0; }
      else if (1 <= hh && hh < 2)   { r1 = x; g1 = c; b1 = 0; }
      else if (2 <= hh && hh < 3)   { r1 = 0; g1 = c; b1 = x; }
      else if (3 <= hh && hh < 4)   { r1 = 0; g1 = x; b1 = c; }
      else if (4 <= hh && hh < 5)   { r1 = x; g1 = 0; b1 = c; }
      else if (5 <= hh && hh < 6)   { r1 = c; g1 = 0; b1 = x; }
      const m = v - c;
      return {
        r: Math.round((r1 + m) * 255),
        g: Math.round((g1 + m) * 255),
        b: Math.round((b1 + m) * 255)
      };
    }
    function rgbToHex(r, g, b) {
      const toHex = (x) => x.toString(16).padStart(2, "0");
      return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
    }
    function hsvToHex(h) {
      const { r, g, b } = hsvToRgb(h, 1, 1);
      return rgbToHex(r, g, b);
    }
    function hsvToHexVal(h, val) {
      const { r, g, b } = hsvToRgb(h, 1, val);
      return rgbToHex(r, g, b);
    }

    // ─── DOM REFERENCES ──────────────────────────────────────────────────────────
    const scoreboardDiv = document.getElementById("scoreboard");
    const btnAddPlayer  = document.getElementById("btnAddPlayer");
    const btnHit        = document.getElementById("btnHit");
    const statusDiv     = document.getElementById("status");
    const txtConn       = document.getElementById("txtConn");
    const txtLastMsg    = document.getElementById("txtLastMsg");
    const ledCircle     = document.getElementById("led");
    const ledStripDiv   = document.getElementById("ledStrip");

    // ─── STATE FOR NEOPIXEL SIM ──────────────────────────────────────────────────
    const LED_COUNT = 16;
    const ledCells = [];

    // ─── SCORE / PLAYER STATE ────────────────────────────────────────────────────
    let playerCount = 0;
    let activeIndex = -1;
    const scores = [];
    const nameInputs = [];
    const scoreSpans = [];
    const playerBoxes = [];

    // ─── FLASH THE SMALL LED CIRCLE ──────────────────────────────────────────────
    function flashCircleLED() {
      ledCircle.classList.add("active");
      setTimeout(() => {
        ledCircle.classList.remove("active");
      }, 200);
    }

    // ─── NEOPIXEL ANIMATION (MATCHES YOUR C‐CODE) ─────────────────────────────────
    async function simulateLEDStrip() {
      // 1) RGB strobe (3×)
      for (let k = 0; k < 3; k++) {
        for (let i = 0; i < LED_COUNT; i++) {
          ledCells[i].style.backgroundColor = "#FF0000";
          ledCells[i].classList.add("on");
        }
        await sleep(100);
        for (let i = 0; i < LED_COUNT; i++) {
          ledCells[i].style.backgroundColor = "#00FF00";
        }
        await sleep(100);
        for (let i = 0; i < LED_COUNT; i++) {
          ledCells[i].style.backgroundColor = "#0000FF";
        }
        await sleep(100);
        for (let i = 0; i < LED_COUNT; i++) {
          ledCells[i].style.backgroundColor = "#000000";
          ledCells[i].classList.remove("on");
        }
        await sleep(100);
      }

      // 2) Rainbow wipe (pixel by pixel)
      for (let i = 0; i < LED_COUNT; i++) {
        const hue = (i * 360 / LED_COUNT) % 360;
        ledCells[i].style.backgroundColor = hsvToHex(hue);
        ledCells[i].classList.add("on");
        await sleep(50);
      }

      // 3) Rainbow pulse (j from 0..255 step 5)
      for (let j = 0; j < 256; j += 5) {
        for (let i = 0; i < LED_COUNT; i++) {
          const hue = ((i * 360 / LED_COUNT) + (j * 360 / 256)) % 360;
          const brightness = (100 + 80 * Math.sin((j * Math.PI) / 128)) / 180;
          ledCells[i].style.backgroundColor = hsvToHexVal(hue, brightness);
        }
        await sleep(20);
      }
      // re‐set full‐bright for all
      for (let i = 0; i < LED_COUNT; i++) {
        const hue = (i * 360 / LED_COUNT) % 360;
        ledCells[i].style.backgroundColor = hsvToHex(hue);
      }

      // 4) Rainbow theater chase
      for (let j = 0; j < 256; j += 32) {
        for (let q = 0; q < 3; q++) {
          for (let i = q; i < LED_COUNT; i += 3) {
            const hue = ((i * 360 / LED_COUNT) + j) % 360;
            ledCells[i].style.backgroundColor = hsvToHex(hue);
            ledCells[i].classList.add("on");
          }
          await sleep(50);
          for (let i = q; i < LED_COUNT; i += 3) {
            ledCells[i].style.backgroundColor = "#000000";
            ledCells[i].classList.remove("on");
          }
        }
      }

      // 5) 3‐second rainbow strobe
      let endTime = Date.now() + 3000;
      let hue = 0;
      while (Date.now() < endTime) {
        for (let i = 0; i < LED_COUNT; i++) {
          ledCells[i].style.backgroundColor = hsvToHex(hue);
          ledCells[i].classList.add("on");
        }
        await sleep(50);
        hue = (hue + (360 * 4096 / 65536)) % 360;
      }

      // Turn them all off
      for (let i = 0; i < LED_COUNT; i++) {
        ledCells[i].style.backgroundColor = "#000000";
        ledCells[i].classList.remove("on");
      }
    }

    // ─── WHEN A “HIT” OCCURS—LOCAL OR VIA WS ──────────────────────────────────────
    function registerHit() {
      flashCircleLED();

      // bump that player’s score
      if (activeIndex >= 0 && activeIndex < scores.length) {
        scores[activeIndex]++;
        scoreSpans[activeIndex].textContent = scores[activeIndex];
      }

      // run NeoPixel sim
      simulateLEDStrip();
    }

    // ─── REMOVE A PLAYER AT INDEX idx ─────────────────────────────────────────────
    function removePlayerAt(idx) {
      // 1) Remove from DOM
      scoreboardDiv.removeChild(playerBoxes[idx]);

      // 2) Splice out of arrays
      nameInputs.splice(idx, 1);
      scoreSpans.splice(idx, 1);
      scores.splice(idx, 1);
      playerBoxes.splice(idx, 1);

      // 3) Adjust activeIndex
      if (idx < activeIndex) {
        activeIndex--;
      } else if (idx === activeIndex) {
        // if removed currently selected, pick index 0 if it exists
        if (scores.length > 0) {
          activeIndex = 0;
          playerBoxes[0].classList.add("selected");
        } else {
          activeIndex = -1;
          btnHit.disabled = true;
        }
      }

      // 4) If there are players but none selected, select the first
      if (scores.length > 0 && activeIndex < 0) {
        activeIndex = 0;
        playerBoxes[0].classList.add("selected");
      }

      // 5) If no players remain, disable “Send Hit”
      if (scores.length === 0) {
        activeIndex = -1;
        btnHit.disabled = true;
      }
    }

    // ─── ADD A NEW PLAYER ─────────────────────────────────────────────────────────
    function addPlayer() {
      playerCount++;
      const idx = playerCount - 1;

      // ── Create container ───────────────────────────────────────────────────────
      const box = document.createElement("div");
      box.className = "playerBox";
      box.id = `playerBox${playerCount}`;

      // “✕” delete button
      const deleteBtn = document.createElement("button");
      deleteBtn.className = "deleteBtn";
      deleteBtn.innerHTML = "✕";
      deleteBtn.title = "Remove this player";
      box.appendChild(deleteBtn);

      // Name input
      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.id = `playerName${playerCount}`;
      nameInput.value = `Player ${playerCount}`;
      nameInput.placeholder = `Player ${playerCount} Name`;
      box.appendChild(nameInput);

      // Score display
      const scoreDiv = document.createElement("div");
      scoreDiv.className = "score";
      scoreDiv.id = `score${playerCount}`;
      scoreDiv.textContent = "0";
      box.appendChild(scoreDiv);

      // Append to scoreboard
      scoreboardDiv.appendChild(box);

      // Remember references
      nameInputs.push(nameInput);
      scoreSpans.push(scoreDiv);
      scores.push(0);
      playerBoxes.push(box);

      // If first player, select them and enable Send Hit
      if (scores.length === 1) {
        activeIndex = 0;
        box.classList.add("selected");
        btnHit.disabled = false;
      }

      // ── Clicking ON the box selects it ─────────────────────────────────────────
      box.addEventListener("click", (e) => {
        // if they clicked the ✕, we let the delete handler run
        if (e.target === deleteBtn) return;

        // remove “selected” from old, add to new
        if (activeIndex >= 0 && activeIndex < playerBoxes.length) {
          playerBoxes[activeIndex].classList.remove("selected");
        }
        const currentChildren = Array.from(scoreboardDiv.children);
        const newIndex = currentChildren.indexOf(box);
        activeIndex = newIndex;
        box.classList.add("selected");
      });

      // ── Delete button handler ─────────────────────────────────────────────────
      deleteBtn.addEventListener("click", () => {
        const allBoxes = Array.from(scoreboardDiv.children);
        const removeIdx = allBoxes.indexOf(box);
        if (removeIdx >= 0) {
          if (removeIdx === activeIndex) {
            box.classList.remove("selected");
          }
          removePlayerAt(removeIdx);
        }
      });
    }

    // ─── WEBSOCKET SETUP & RECONNECT ─────────────────────────────────────────────
    let socket = null;
    function connectWebSocket() {
      socket = new WebSocket(WS_URL);

      socket.addEventListener("open", () => {
        statusDiv.textContent = "WebSocket connected!";
        txtConn.textContent = "Connected";
        if (scores.length > 0) {
          btnHit.disabled = false;
        }
      });
      socket.addEventListener("close", () => {
        statusDiv.textContent = "WebSocket closed.";
        txtConn.textContent = "Closed";
        btnHit.disabled = true;
        setTimeout(connectWebSocket, 2000);
      });
      socket.addEventListener("error", (e) => {
        console.warn("WebSocket error:", e);
      });
      socket.addEventListener("message", (event) => {
        const msg = event.data.trim();
        txtLastMsg.textContent = msg;
        if (msg.toLowerCase() === "hit") {
          registerHit();
        }
      });
    }

    // ─── ON PAGE LOAD: BUILD PIXEL SIM, HOOK UP BUTTONS, START WS ─────────────────
    window.addEventListener("load", () => {
      // 1) Create 16 .ledPixel DIVs
      for (let i = 0; i < LED_COUNT; i++) {
        const pix = document.createElement("div");
        pix.className = "ledPixel";
        pix.style.backgroundColor = "#000000";
        ledStripDiv.appendChild(pix);
        ledCells.push(pix);
      }

      // 2) “Add Player” → addPlayer()
      btnAddPlayer.addEventListener("click", addPlayer);

      // 3) “Send Hit” → send over WS, then local registerHit()
      btnHit.addEventListener("click", () => {
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send("hit");
          txtLastMsg.textContent = "➡ hit (sent)";
          registerHit();
        }
      });

      // 4) Initially no players, so disable “Send Hit”
      btnHit.disabled = true;

      // 5) Start WebSocket
      connectWebSocket();
    });
  </script>
</body>
</html>
